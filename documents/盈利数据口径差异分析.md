# 盈利数据口径差异分析报告

## 问题描述

用户发现在可视化输出中，两个地方显示的总盈利额数据不一致：

1. **按市值大小的盈利金额占比**页面显示：总盈利额 = ¥111,238,887
2. **日度绝对盈利（盯市）**页面显示：合计绝对盈利 = ¥50,017,636

差异达到 **¥61,221,251**（约122.4%的差距）

## 数据来源分析

### 1. 按市值盈利占比的数据来源

**文件位置**: `lightweight_analysis.py` 第 2674-2689 行

**计算逻辑**:
```python
# 只选择 absolute_profit > 0 的交易对
profits = pairs[pairs['absolute_profit'] > 0].groupby('code')['absolute_profit'].sum()
total_profit = float(profits['Profit'].sum())
```

**数据特征**:
- 数据源：交易配对结果 (`data/paired_trades_fifo.parquet`)
- 总交易对数：4,956,827 笔
- **只统计了盈利 > 0 的交易对**：2,667,226 笔（53.8%）
- 盈利交易总和：¥111,238,887.48

### 2. 日度绝对盈利的数据来源

**文件位置**: `lightweight_analysis.py` 第 4874-4890 行

**计算逻辑**:
```python
# 计算每日NAV变化
mtm_df['daily_abs_profit'] = mtm_df['total_assets_num'].diff()
total_profit = profit_series.sum()  # 累加所有日度盈利（含正负）
```

**数据特征**:
- 数据源：盯市分析结果 (`mtm_analysis_results/daily_nav_revised.csv`)
- 交易日数：242 天
- 初始NAV：¥9,359,546
- 最终NAV：¥59,377,184
- **NAV总变化**：¥50,017,638（包含所有盈亏）

## 根本原因

### 核心差异

两个指标计算的**统计口径完全不同**：

| 指标 | 统计对象 | 是否包含亏损 | 计算基础 |
|------|---------|------------|---------|
| 按市值盈利占比 | 每笔交易对 | ❌ 只统计盈利>0的交易 | 交易配对的 absolute_profit |
| 日度绝对盈利 | 每日账户 | ✅ 包含所有盈亏 | NAV日度变化累计 |

### 数据验证

通过脚本验证发现：

```
✓ 交易配对数据统计:
  - 所有交易对总盈利(含亏损): ¥46,243,413.65
  - 仅正盈利交易对总和: ¥111,238,887.48
  - 亏损交易对总和: ¥-64,995,473.83
  
✓ 盯市分析统计:
  - NAV变化(最终-初始): ¥50,017,638.00
```

### 两者差异的原因

1. **¥111,238,887（按市值盈利占比）** = 只统计盈利交易
2. **¥46,243,414（所有交易配对含亏损）** ≈ **¥50,017,638（日度盈利累计）**

两者还存在约 ¥3,774,224 的差异（约7.5%），可能来自：
- 交易配对算法未能完全匹配所有订单（持仓尾差）
- 盯市计算包含了未平仓持仓的市值变动
- 手续费计算口径细微差异

## 修正建议

### 方案一：修改页面标题和说明（推荐）

在 `lightweight_analysis.py` 中修改相关代码：

```python
# 第 2685 行附近
fig_mc_p.update_layout(title='按市值大小的盈利交易占比（不含亏损）', showlegend=True)
mc_p_metrics = {
    '总盈利额（仅盈利交易）': f"¥{total_profit:,.0f}",
    '盈利交易占比': f"{len(positive_pairs)/len(pairs)*100:.1f}%",
    '最大类别': (mc_p_labels[int(np.argmax(mc_p_values))] if len(mc_p_values) else 'NA')
}
```

**页面说明添加**：
```html
<p><b>统计口径</b>: 本页面仅统计 absolute_profit > 0 的盈利交易对，
不包含亏损交易。总盈利额 ¥111,238,887 代表所有盈利交易的累计金额，
实际净盈利需扣除亏损交易约 ¥65,000,000，
真实净利润约 ¥46,243,414（与日度盈利累计 ¥50,017,638 基本一致）。</p>
```

### 方案二：同时展示盈利和亏损分布

增加两个并列的饼图：

1. **盈利交易分布**（当前）
   - 标题明确标注"盈利交易"
   - 总盈利额：¥111,238,887

2. **亏损交易分布**（新增）
   - 按市值/行业/板块分类的亏损金额占比
   - 总亏损额：¥-64,995,474

3. **净盈利指标**（新增）
   - 净盈利 = 总盈利 - 总亏损 = ¥46,243,414
   - 盈亏比 = 111.24M / 65.00M = 1.71
   - 盈利交易占比 = 53.8%

### 方案三：统一口径（最彻底）

修改计算逻辑，使用所有交易对（含亏损）：

```python
# 修改第 2676 行
# 原代码：
profits = pairs[pairs['absolute_profit'] > 0].groupby('code')['absolute_profit'].sum()

# 修改为：
profits = pairs.groupby('code')['absolute_profit'].sum()  # 包含所有盈亏
# 然后只对正值进行可视化，但在说明中明确包含了亏损
```

## 代码实现示例

```python
def market_cap_profit_loss_analysis(self, pairs, meta):
    """按市值大小的盈亏分析（改进版）"""
    
    # 1. 盈利交易
    profit_pairs = pairs[pairs['absolute_profit'] > 0]
    profit_by_code = profit_pairs.groupby('code')['absolute_profit'].sum().reset_index()
    profit_by_code.columns = ['Code', 'Profit']
    total_profit = profit_by_code['Profit'].sum()
    
    # 2. 亏损交易
    loss_pairs = pairs[pairs['absolute_profit'] < 0]
    loss_by_code = loss_pairs.groupby('code')['absolute_profit'].sum().reset_index()
    loss_by_code.columns = ['Code', 'Loss']
    total_loss = loss_by_code['Loss'].sum()
    
    # 3. 净盈利
    net_profit = total_profit + total_loss  # total_loss是负数
    
    # 4. 合并市值信息
    profit_enriched = profit_by_code.merge(
        meta[['Code', 'MarketCapBucket']], on='Code', how='left'
    )
    loss_enriched = loss_by_code.merge(
        meta[['Code', 'MarketCapBucket']], on='Code', how='left'
    )
    
    # 5. 按市值分组
    mc_profit = profit_enriched.groupby('MarketCapBucket')['Profit'].sum()
    mc_loss = loss_enriched.groupby('MarketCapBucket')['Loss'].sum()
    
    # 6. 关键指标
    metrics = {
        '总盈利额': f"¥{total_profit:,.0f}",
        '总亏损额': f"¥{total_loss:,.0f}",
        '净盈利': f"¥{net_profit:,.0f}",
        '盈亏比': f"{abs(total_profit/total_loss):.2f}" if total_loss != 0 else 'N/A',
        '盈利交易占比': f"{len(profit_pairs)/len(pairs)*100:.1f}%"
    }
    
    # 7. 生成双饼图可视化...
```

## 结论

1. **数据本身没有错误**，只是统计口径不同
2. **¥111,238,887** 是正确的"盈利交易总和"
3. **¥50,017,638** 是正确的"净盈利（含亏损）"
4. 两者差异主要是**是否包含亏损交易**的问题

## 建议采取的行动

1. ✅ **立即执行**：更新页面说明文字，明确标注统计口径
2. ✅ **短期优化**：在指标表中同时显示盈利、亏损和净盈利
3. 🔄 **长期改进**：增加盈亏分布对比图表，全面展示交易表现

---

**生成时间**: 2025-01-07  
**分析工具**: check_profit_difference.py  
**数据版本**: 截至 2024-12-31

