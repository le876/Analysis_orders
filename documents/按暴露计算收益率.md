## 目标
- 在不依赖“初始资金”假设的前提下，给出可比、可复现实验的“按暴露回报”收益率序列，用于跨策略/跨时段对比。
- 严格区分绝对金额与相对指标，避免初始资金设定导致的收益率失真。
- 在现有盯市流水（NAV、long_value、short_value、fees）基础上实现，无需改动交易数据结构。

---

## 核心定义
- 当日净值 NAV: \(\text{NAV}_t = \text{Cash}_t + \text{LongValue}_t - \text{ShortValue}_t\)
- 当日 PnL（含费用）: \(\text{PnL}_t = \text{NAV}_t - \text{NAV}_{t-1}\)（第1日跳过或单独处理）
- 当日毛暴露（Gross Exposure）: \(E^{\mathrm{gross}}_t = |\text{LongValue}_t| + |\text{ShortValue}_t|\)
- 当日净暴露（Net Exposure）: \(E^{\mathrm{net}}_t = |\text{LongValue}_t - \text{ShortValue}_t|\)

按暴露回报（Exposure-Adjusted Return）的推荐口径：

\[\boxed{\ \ r^{\mathrm{gross}}_t = \dfrac{\text{PnL}_t}{\max(\varepsilon,\ E^{\mathrm{gross}}_{t-1})}\ \ }\]

说明：
- 以“昨日毛暴露”为分母可避免前视偏差；\(\varepsilon\) 为极小正数或阈值，避免除零。
- 也可使用“昨日平均暴露”\(\bar{E}_{t-1} = (E^{\mathrm{gross}}_{t-1}+E^{\mathrm{gross}}_{t-2})/2\) 以减小剧烈变动带来的噪声。
- 若关注方向性能力，可同时输出：\(r^{\mathrm{long}}_t = \text{PnL}_t/\max(\varepsilon,\ \text{LongValue}_{t-1})\)，\(r^{\mathrm{short}}_t = \text{PnL}_t/\max(\varepsilon,\ \text{ShortValue}_{t-1})\)（仅作诊断，不用于直接比较）。

---

## PnL 的计算原理（与实现对齐）
1. 现金结算：按日汇总当日所有成交的现金流与费用，\(\text{Cash}_t = \text{Cash}_{t-1} + \sum(\text{卖出金额}) - \sum(\text{买入金额}) - \sum(\text{费用})\)。
2. 持仓估值：多头按收盘价计入资产，空头按收盘价计入负债绝对值；停牌/缺价使用“对齐交易日并前向填充”的兜底价（已在价格对齐逻辑中实现）。
3. 净值与 PnL：\(\text{NAV}_t = \text{Cash}_t + \text{LongValue}_t - \text{ShortValue}_t\)，\(\text{PnL}_t = \Delta \text{NAV}_t\)。该口径天然包含已实现与未实现盈亏及全部交易费用。
4. 与初始资金无关：\(\text{PnL}_t\) 由“当日与前日的资产负债表差值”给出，对初始资金只在“第1日起点”产生常数平移影响；因此按暴露回报从第2日起具有可比性。

---

## 为什么“按暴露回报”有参考价值
- 规模无关（Scale-invariant）：用“投入风险资本（暴露）”做分母，剥离了下单规模与初始资金假设的影响。
- 跨策略可比：不同策略暴露路径差异大（对冲/中性/趋势），以暴露标准化后才能客观比较单位风险资本的产出效率。
- 运营指导：结合换手与费用，可评估“单位暴露的净产出”，用于调参（持仓上限、目标杠杆、仓位分配）。
- 风险监控：若 \(r^{\mathrm{gross}}\) 在暴露较高时显著恶化，提示“拥挤/容量”或“冲击成本”问题。

---

## 计算口径与实现计划（可交付给实现方）
1. 输入数据
   - `daily_nav_revised.csv`（由盯市脚本产出）：字段包含 `date, cash, long_value, short_value, total_assets, daily_return, cumulative_return, leverage, turnover`（字符串格式需反解析为数值）。
   - 可选：如实现端不依赖 CSV，可直接在 `MarkToMarketAnalyzer` 内部使用 `self.daily_nav` DataFrame。

2. 预处理
   - 字符串数值转 float（移除千分位逗号，百分号等）。
   - 生成数值列：`cash_num, long_value_num, short_value_num, total_assets_num`。
   - 生成暴露：`gross_expo_t = long_value_num + short_value_num`。

3. 计算序列
   - PnL：`pnl_t = total_assets_num.diff()`；第1日设为 `NaN` 或用 `total_assets_1 - total_assets_0` 后在输出时丢弃第1日。
   - 分母暴露：`denom_t = gross_expo.shift(1)`；如需更稳健，`denom_t = (gross_expo.shift(1)+gross_expo.shift(2))/2`。
   - 阈值与屏蔽：若 `denom_t < expo_min`（如 1e5 或 `median(gross_expo)*5%`），则 `r_t = NaN`（避免小分母导致的失真）。
   - 回报：`r_expo_t = pnl_t / denom_t`。
   - 统计：均值、标准差、IR、胜率、分位数、分母覆盖率（有效样本占比）。

4. 可选：构造“等目标暴露”的归一化指数（Managed Notional）
   - 设目标暴露 \(E^*\)（如全样本中位数或用户指定），构造指数：
     \[I_t = I_{t-1}\,\big(1 + \text{PnL}_t / E^*\big),\quad I_0=1.0\]
   - 该指数可视作“若每日都以固定风险资本 \(E^*\) 运行，策略的归一化净值曲线”。

5. 可视化与落地
   - 产出 `exposure_return.csv`：`date, pnl, gross_expo, r_expo, valid_flag`。
   - 新增图表：
     1) `r_expo` 时间序列（含 20D 均线与分位带）。
     2) `r_expo` 与 `gross_expo` 双轴图（检视“高暴露是否摊薄回报”）。
     3) 可选 `Managed Notional Index` 曲线。

---

## 计算注意事项（务必严格执行）
1. 第1日处理：跳过或单独展示，不参与统计（因与初始资金的起点定义相关）。
2. 暴露阈值：设置 `expo_min`，并在指标中报告“有效样本占比”；避免暴露极小导致的极端比值。
3. 价格与对齐：暴露与 NAV 使用同一收盘价体系；缺价使用“交易日日历对齐 + 前向填充”。
4. 费用一致性：PnL 必须包含费用（交易费、税费）；若未来加入融资利息/借券费/股息，应同步计入现金流，以避免口径漂移。
5. 外推/合成：禁止将 `r_expo` 作为“可复利”的资金回报直接累乘；如需净值曲线，请使用上文 `Managed Notional` 方法。
6. 极值裁剪：在图表展示层面对 `r_expo` 进行温和裁剪（如 \([-50\%,50\%]\)），但原始值保留在 CSV 以供审计。
7. 诊断拆分：建议同时输出 `r_expo` 与 `turnover`、`leverage` 的相关性，定位容量/冲击问题。

---

## 验证与自检清单
1. 初始资金不变性：改变 `initial_capital`，`r_expo`（从第2日起）应保持不变；若不一致，检查 PnL 与分母口径。
2. 价格对齐一致性：随机抽样 20 日，核对 `NAV 变动 = 现金变动 + 多空市值变动`。
3. 暴露阈值敏感性：报告在不同 `expo_min` 下的有效样本占比与均值差异。
4. 对比口径：与“常规日收益率”（基于 NAV 的 `daily_return`）并排展示，验证在规模变化情形下 `r_expo` 的稳定性。

---

## 输出物与接口
- `exposure_return.csv`：标准化回报数据集。
- `exposure_return_light.html`：按暴露回报的可视化报告。
- 在 `mark_to_market_analysis.py` 中新增函数 `compute_exposure_return(expo='gross', expo_min=None, target_expo=None)`，并在 `save_results()` 时一并写出。

> 说明：本计划为实现端提供了完全可复现的公式、阈值策略与校验流程。请严格按“昨日暴露为分母、包含费用的 PnL、首日跳过”的口径执行，以保证结果具有跨数据集与跨资金规模的可比性。











