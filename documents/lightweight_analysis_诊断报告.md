# lightweight_analysis.py 分析诊断报告（原理性正确性审查）

> 目的：逐块对脚本的计算与可视化逻辑进行专业审查，识别事实性/原理性问题，提出规范化修正建议，以保证分析结果在量化交易中的方法口径正确。

## 结论概览
- 需要立即修正：
  - IC主口径与标签对齐（T+1定义核实，否则存在错位风险）。
  - 极端分组（G1/G10）当前以“组内相关”衡量，统计含义偏弱，应改为“分位组合收益 + G10-G1多空”。
  - 时段分析与开盘10分钟标注按买入字段（buy_*）归因，空头开仓被系统性遗漏，应统一使用开仓字段（open_*）。
  - 综合成本率计算采用“均值比均值”，应改为“∑费/∑额 + 金额加权滑点（方向签名）”。
  - 回退口径中对 real 的“自动缩放(/100,/10000)”与“±15%裁剪”不应参与指标计算（仅可用于可视化降噪）。
- 合理/可保留：
  - 基准收益用 pct_change 与复利累积，并打印等价校验，方法正确。
  - PnL/Spend 作为现金效率口径单独展示，不与复利年化混用，专业合理。
  - 配对（FIFO）构建完整交易，含一致性校验与卖出量对齐校验，设计严谨。
  - 盯市PnL与配对PnL的Recon设计合理，差额来源披露清楚。

---

## 详细诊断

### 1. 数据加载与抽样策略
- 位置：load_and_sample_data
- 现状：对 self.df 的 real 做 ±5σ剔除，并在 >50k 行时进行“分日抽样（每日至多2k）”。
- 风险：
  - 尾部剔除与抽样会改变统计分布，影响收益、波动、回撤、胜率等估计，属于“先验处理影响结论”。
- 建议：
  - 所有指标计算阶段一律使用 `orders.parquet` 全量数据；为降低计算量，只允许在全量载入后生成“股票-日”或“股票-时段”聚合表，再基于聚合结果统计，禁止剔除或抽样原始样本行。
  - 可视化降噪与极值处理应限定在展示链路，如在绘图前对展示 DataFrame 做 winsorize（0.1%/99.9%分位），不得影响指标源数据。
  - 当前脚本在“完整交易分析”阶段已二次读取原始数据避免抽样偏差，此方向正确，建议推广到其它模块，保证多处分析共享一致的全量基表。

### 2. 基准收益计算
- 位置：load_benchmark_data
- 评估：
  - 日收益率 pct_change、复利累积、与端点收益等价校验均正确。
- 建议：
  - 与策略日历对齐（内连接对齐交易日）避免错位；对节假日/停牌日做合理处理。

### 3. IC 与 RankIC 口径
- 位置：model_performance_analysis
- 现状：先按“股票-日”聚合 pred/real，再计算 real_next=shift(-1)，将 ic_next 作为主序列；另给 ic_same/rank_ic 等。
- 风险：
  - 若 real 已为“t时刻可用于预测的前瞻标签”，则 pred_t vs real_t 本身就是 T+1 评估；此时再 shift(-1) 将形成 T+2 错位。
- 建议：
  - 明确 real 的定义（单位/对齐/是否前瞻）；若其为“t→t+1收益标签”，则以 ic_same 作为主口径，ic_next 仅作敏感性分析。

- 极端分组（G1/G10）问题：
  - 现做法是在组内计算“pred-收益相关”，统计含义偏弱；应改为：
    - 按pred分位分组，比较各组未来平均收益/累计收益/IR；
    - 重点展示 G10-G1 多空组合的收益与显著性。

### 4. 预测-真实与配对逻辑（FIFO）
- 位置：pred_real_relationship_analysis
- 亮点：
  - FIFO构造完整交易对，盈亏=卖出额-买入额-双边费；价格差×数量一致性检验与卖出数量对齐核验，严谨。
- 问题：
  - 对空头交易未记录 open 侧的 pred（当前 buy_pred 为多头买入时的预测值，空头开仓在卖出侧被置 NaN），导致“按开仓预测值分组”的分析只覆盖多头，系统性遗漏空头贡献。
- 建议：
  - 在配对输出中统一记录 open_pred/open_real/open_timestamp/open_notional（多头取买入、空头取卖出）；所有“按开仓归因”的分析基于 open_* 字段，覆盖多空交易。

### 5. 三种日收益计算口径
- 位置：performance_metrics_analysis
- 现状：
  - 等权/金额加权：优先用配对的平仓日/买入日归因；回退到 real 时，对 real 做启发式缩放(/100,/10000)与 ±15%裁剪。
  - PnL/Spend：NAV差分/当日买入额，现金效率口径，未使用复利年化，专业合理。
- 风险：
  - 启发式缩放依据样本均值阈值，容易误判单位；裁剪参与指标会偏移统计。
- 建议：
  - 固化 real 的单位/口径（配置或元信息），移除启发式缩放；裁剪仅在图表展示使用，指标计算用原值/聚合值。
  - 增加“G10-G1多空组合”的日序列与统计，对比策略序列更具解释力。

### 6. 滑点与综合成本
- 位置：slippage_cost_analysis
- 现状：
  - 时间滑点、数量滑点、价格滑点（成交均价 vs 订单价）计算合理；异常值截断固定阈值。
  - 综合成本率=|均价滑点| + (fee_mean / 当日“平均”成交额)*100。
- 原理性问题：
  - 手续费率应为“总费用/总成交额×100”，非“均值/均值”；价格滑点建议使用“金额加权均值”，并使用“方向签名滑点成本”处理买卖方向。
- 建议：
  - fee_rate = (∑fee / ∑tradeAmount)×100；
  - price_slip = 金额加权均值( sign(direction)×(exec-decision)/decision×100 )；
  - 综合成本 = fee_rate + max(0, -price_slip) 或明确展示双向成本与滑点。
  - 异常阈值建议改为分位数截尾（如P1/P99）。

### 7. 时段分析与热力图/瀑布图
- 位置：slot_performance_analysis
- 现状：
  - 多处按 buy_* 字段统计收益率=absolute_profit/buy_amount；“开盘10分钟”标注也用 buy_timestamp 过滤。
- 原理性问题：
  - 空头开仓发生在卖出侧，buy_* 口径遗漏空头。
- 建议：
  - 统一改为开仓口径：open_timestamp/open_slot/open_notional 与 absolute_profit 归因到“开仓时段”；
  - 瀑布图的“开盘10分钟”也采用 open_timestamp 筛选（09:30-09:40），并说明第一柱对应09:30-10:00的30分钟；
  - 可选补充平仓维度分析与持仓时长分布。

### 8. 因子暴露构建
- 位置：_build_factor_dataset / factor_exposure_analysis
- 现状：
  - 策略端暴露=当日“买入流量”加权均值；市场端=市值加权均值（缺失回退等权）。
- 评估：
  - 属于“流量暴露”，能解释“买入筛选”的风格偏好；与“持仓暴露”不同但互补。
- 建议：
  - 页面明确“流量暴露”口径；可新增“持仓暴露”（若有持仓/资金曲线）页作对照。
  - 高频β、RV、日内振幅对齐策略合理，继续保持稳健阈值。

### 9. 日度绝对盈利与Recon
- 位置：daily_absolute_profit_analysis
- 现状：
  - 盯市PnL来自NAV差分；Recon=已实现（配对）+未实现（收盘价或最后成交价近似）；与盯市PnL对比并输出差额度量。
- 评估：
  - 设计合理，建议优先使用真实收盘价缓存以减少近似误差，并在页面摘要标注 Recon 差额范围。

---

## 优先级修复路线图（建议）
1) 明确 real 标签口径并修正 IC 主口径（ic_same vs ic_next）。
2) 极端分组：改“组内相关”为“分位组合收益 + G10-G1多空”。
3) 统一开仓口径：用 open_* 字段重写时段/瀑布/热力图/箱线/气泡与“开盘10分钟”标注。
4) 综合成本率：改为 (∑fee/∑成交额) + 金额加权“方向签名滑点成本”。
5) 清理回退缩放与参与指标的裁剪，仅在可视化时winsorize。
6) 输出补充：G10-G1序列与组间差统计；（可选）新增“持仓暴露”页。

---

## 需要确认的信息（以便精修）
- real 的单位与定义：是否为“t时点可用的前瞻收益标签”（t→t+1）？是否已含费/滑点？
- 订单价格/基准价口径：price 是下单价还是撮合前参考价？是否包含委托调整？
- NAV来源：盯市资产是否含资金进出/分红/融资利息等？

---

## 备注
- 本报告对应 lightweight_analysis.py 当前版本的静态审查，未涉及真实回放与逐笔回测；在修正后建议以小样本复核关键页（IC主图、三法收益对比、滑点成本、时段瀑布）以确认行为符合预期。
