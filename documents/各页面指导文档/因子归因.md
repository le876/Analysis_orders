# 因子构建
异象研究：规模、价值、盈利以及换手率在A股中被定价，在实际因子投资中，可以考虑从这四个维度构建因子，对A股市场进行异象研究

## 市场因子
目标：市场因子的核心目标是捕获特定股票市场（在此场景下为深圳证券交易所）的整体系统性风险，并量化其对应的风险溢价。任何应用于该市场的策略，其收益中由市场整体涨跌驱动的部分，都应由这个因子来解释。

数据源 (根据您的数据集说明)：
- 市场组合代理 (Market Portfolio Proxy)：深圳证券交易所成份股价指数 (简称：深证成指)，代码 399001.SZ。

- 无风险利率 (Risk-Free Rate)：3个月上海银行间同业拆放利率 (3-Month SHIBOR)。

- 数据频率 (Data Frequency)：交易日 (Daily)。

- 价格类型 (Price Type)：后复权收盘价 (Adjusted Close Price)。

在构建市场因子时，选用所有股票按照总市值加权的方式，以此得到的投资组合就是市场因子的投资组合。

以下是构建该因子的每一个具体步骤。

#### **第一步：获取市场组合日收益率 ($R_{M,t}$)**

此步骤旨在计算出代表深交所整体市场表现的每日回报率。

 **1.1. 数据提取 (Data Extraction):**
     **输入**: `深证成指 (399001.SZ)` 的日度时间序列数据。
     **字段**: `后复权收盘价 (Adjusted Close Price)`。
     **操作**: 提取您回测周期内每一个交易日 $t$ 的后复权收盘价，记为 $P_t$。

 **1.2. 收益率计算 (Return Calculation):**
     **输入**: 时间序列 $P_t$。
     **操作**: 对于每一个交易日 $t$ (从回测周期的第二天开始)，使用当日和前一日的后复权收盘价计算日收益率 $R_{M,t}$。
     **公式**:
        $$R_{M,t} = \frac{P_t}{P_{t-1}} - 1$$
     **输出**: 得到一条每日市场组合收益率的时间序列 $R_{M,t}$。

#### **第二步：获取同期无风险日收益率 ($R_{f,t}$)**

此步骤旨在将年化的无风险利率转换为与市场组合收益率周期匹配的日度无风险利率。

 **2.1. 数据提取 (Data Extraction):**
     **输入**: `3个月SHIBOR` 的日度时间序列数据。
     **注意**: 该数据通常以**年化百分比**的形式提供。例如，如果某日的值为2.5，则代表年化利率为2.5%。
     **操作**: 提取每一个交易日 $t$ 对应的年化利率，记为 $R_{f, annual, t}$。

 **2.2. 年化利率转日化 (De-annualize the Rate):**
     **输入**: 年化利率时间序列 $R_{f, annual, t}$。
     **操作**: 将年化利率除以一年的天数（通常为365），将其转换为日度利率 $R_{f,t}$。如果原始数据是百分比形式，请先转换为小数。
     **公式**:
        $$R_{f,t} = \frac{R_{f, annual, t}}{100 \times 365}$$
     **输出**: 得到一条每日无风险收益率的时间序列 $R_{f,t}$。

#### **第三步：计算市场因子（市场超额收益 $MKT_t$）**

此步骤是最终合成因子，计算市场回报率超过无风险回报率的部分。

 **3.1. 差值计算 (Calculate the Difference):**
     **输入**: 每日市场组合收益率序列 $R_{M,t}$ 和每日无风险收益率序列 $R_{f,t}$。
     **操作**: 确保两个时间序列的日期严格对齐。对于每一个交易日 $t$，将市场组合日收益率减去无风险日收益率。
     **公式**:
        $$MKT_t = R_{M,t} - R_{f,t}$$
     **最终输出**: 得到一条每日**深交所市场因子**的时间序列 $MKT_t$。这就是您策略所需的市场因子。

#### 4. 总结与注意事项

| 环节 | 输入数据/变量 | 处理过程 | 输出结果 |
| :--- | :--- | :--- | :--- |
| **市场组合** | `399001.SZ` 后复权日收盘价 $P_t$ | $R_{M,t} = (P_t / P_{t-1}) - 1$ | 市场组合日收益率 $R_{M,t}$ |
| **无风险利率** | `3个月SHIBOR` 年化利率 $R_{f, annual, t}$ | $R_{f,t} = R_{f, annual, t} / 36500$ | 无风险日收益率 $R_{f,t}$ |
| **因子合成** | $R_{M,t}$ 和 $R_{f,t}$ | $MKT_t = R_{M,t} - R_{f,t}$ | **深交所市场因子日度序列 $MKT_t$** |

**关键注意事项：**

1.  **指数代表性**：深证成指是由深交所市场中规模大、流动性好的代表性股票组成，按市值加权编制。对于一个仅投资于深交所的策略，它是一个非常合适的基准和市场代理，完全符合《因子投资》一书中的选取代价。
2.  **数据对齐**：在执行第三步时，必须确保两个输入的时间序列（$R_{M,t}$ 和 $R_{f,t}$）在日期上是**完全匹配**的。如果某一交易日缺少无风险利率数据，通常使用前一个交易日的数据进行填充（forward fill）。
3.  **复权类型**：务必使用**后复权**数据计算指数收益率。如书中3.1.2节所述，这能保证收益率的计算真实反映了包括分红、配股在内的所有股东权益变化，避免价格出现跳空缺口导致的计算错误。
4.  

## 规模因子
### 1. 因子目标

目标：规模因子的核心目标是**捕获“规模效应”(Size Effect)** 。该效应指的是，从长期来看，小市值公司的股票（小盘股）的平均收益率系统性地高于大市值公司股票（大盘股）的现象 。
因此，可以构建一个多空对冲的投资组合，该组合能够有效分离并量化出纯粹由公司规模差异带来的那部分超额收益，即**规模溢价 (Size Premium)**。

### 2. 核心原则与数据源

 **构造原则**：遵循《因子投资》一书中构建多空组合以捕捉风格溢价的逻辑，即“做多”具备某种预期高收益特征的股票组合，“做空”具备对立特征的股票组合。
 **数据源**:
     **股票池 (Stock Universe)**：仅包含在**深圳证券交易所 (SZSE)** 上市的股票。
     **排序变量 (Sorting Variable)**：**总市值 (Total Market Capitalization)**。
     **数据频率 (Data Frequency)**：**月度 (Monthly)** 调仓。
     **价格类型 (Price Type)**：**后复权收盘价 (Adjusted Close Price)**，用于计算组合收益。

### 因子构造：单变量排序法 (Univariate Sort)
**第一步：获取截面总市值数据 (Obtain Cross-Sectional Market Cap Data)**
  **1.1. 数据提取**:
        * **输入**: 股票池中所有深交所上市股票。
        * **时间点**: 在每个月末调仓日 $t$。
        * **字段**: `总市值 (Total Market Capitalization)`。
        * **操作**: 提取在调仓日 $t$，股票池内所有正常交易股票的总市值数据，记为 $MC_{i,t}$ (其中 $i$ 代表具体某只股票)。

  **第二步：排序与分组 (Sort and Group)**
     **2.1. 排序**:
      **输入**: 截面总市值数据 $MC_{i,t}$。
    **操作**: 将所有股票按照总市值 $MC_{i,t}$ **从低到高**进行升序排列。
  **2.2. 分组**:
    **操作**: 将排序后的股票列表平均分成10个组（即按十分位数切分）。
    **命名**:
           第一组（市值最小的10%）命名为 `Small` 组。
           第十组（市值最大的10%）命名为 `Big` 组。




## Size (市值) 因子
目标: 


构建方法:

基础市值因子 (ln_market_cap): 直接使用每只股票每日的总市值的自然对数。

公式: Size Factor = ln(Total Market Cap)

原因: 取对数可以使因子的分布更接近正态分布，减小极端大市值公司的影响，使数据更平滑。

中盘效应: 捕捉非线性规模效应。一种进阶做法是在后续的回归模型中，除了引入ln(市值)，再额外引入它的平方项 (ln(市值))^

## Volatility (波动率) 因子
目标: 衡量“综合β 与超额收益波动率”。这是一个复合因子，需要分解。

构建方法:

 高频Beta: 使用过去200个1分钟K线数据，将个股的分钟收益率对股指期货（如IF主力合约）的分钟收益率进行滚动回归，得到分钟级的Beta。
 已实现波动率 (Realized Volatility): 计算在过去一个较短窗口内（如过去30分钟）的分钟收益率的标准差。这是衡量短期真实波动最直接的指标。
 价格振幅 (Price Range): 计算 (High - Low) / Close，可以使用5分钟或15分钟K线来计算，反映了短期内的价格博弈激烈程度。
 低频的波动率衡量的是月度级别的风险，对于高频策略来说太“迟钝”了。高频策略关心的是未来几分钟或几小时的波动性，因此必须使用分钟级的数据来捕捉这种稍纵即逝的特征。

## Liquidity (流动性) 因子
目标: 衡量“月度/季/年换手率与日频交易量加权”的综合流动性。

构建方法:

1. 买卖价差 (Bid-Ask Spread): 这是最核心的高频流动性指标。可以直接使用盘口快照（Snapshot）数据计算 (盘口卖一价 - 盘口买一价) / 中间价。
2. 盘口深度 (Order Book Depth): 衡量盘口挂单量的大小，例如买一至买五档的总挂单金额。
3. 分钟级Amihud指标: 将经典的Amihud非流动性指标应用在分钟K线上，计算分钟收益率

公式: Amihud = mean(|日收益率| / 日成交额) (通常计算月度平均值)

解读: Amihud指标值越高，代表流动性越差。

指标合成:

标准化: 由于上述各指标的量纲不同，需要先对它们各自在全市场所有股票的截面上进行标准化处理（例如，计算z-score），使其均值为0，标准差为1。

加权/等权合成: 将标准化后的 Turnover_Month, Turnover_Quarter, Turnover_Year, Amihud (可能需要取负号以统一方向，使得因子值越大代表流动性越好) 等权重相加，或者根据您的经验赋予不同权重，最终得到一个综合的流动性因子得分。

## 4. 短周期动量/反转因子 (Momentum / Reversal)
这是高频领域最核心、最重要的因子类别，没有之一。经典的6-12个月动量因子描述的是长期趋势，而高频策略捕捉的是短时间内的价格惯性或耗尽。

因子构建:

动量 (Momentum): 计算过去N个时间单位的累计收益率。例如，R_30m 代表过去30分钟的收益率。如果为正且较大，则代表短期强势。

反转 (Reversal): 计算更短时间窗口的累计收益率。例如，R_5m 代表过去5分钟的收益率。通常极短期的价格暴涨暴跌后会出现反转。

分析价值:

通过分析您的策略在不同周期（5分钟、30分钟、60分钟）动量因子上的暴露度，可以清晰地判断出：您的策略究竟是一个追涨杀跌的“趋势跟随”型策略，还是一个高抛低吸的“反转”型策略。这是对其交易逻辑最根本的剖析。

## 5. 价值因子 (Value) - 作为风格因子
经典的价值因子（如市盈率P/E、市净率P/B）是典型的低频风格因子。

因子构建: 直接使用财报数据计算的P/E、P/B、P/S等指标即可。这些数据通常按季度更新。

分析价值:

价值因子在高频交易中不作为直接的买卖信号，但它能告诉我们策略的“选股偏见”。

应用场景: 您的策略是否只在“低估值”的股票池里寻找高频交易机会？还是说它对估值完全不敏感？通过分析策略持仓的平均P/E，可以回答这个问题。这有助于理解策略的风险暴露，例如，在市场风格从成长股切换到价值股时，您的策略可能会受到何种影响。

## 6. 质量因子 (Quality) - 作为风格/

与价值因子类似，质量因子（如净资产收益率ROE、毛利率、杠杆率）也是低频风格因子。

因子构建: 基于季度或年度财报计算ROE、ROA、毛利率、资产负债率等。

分析价值:

风控排雷: 质量因子是极佳的“排雷”工具。一个优秀的高频策略，可能会首先利用质量因子剔除掉那些有财务风险、基本面很差的公司，然后再在“好公司”的池子里执行高频信号。

识别偏好: 分析策略持仓的平均ROE，可以判断它是否偏好于在那些盈利能力强的“白马股”上进行交易。

## 7.盈利因子

# 因子分析


## 策略因子特征暴露度分析
这一步的目标是描绘出您的策略在“因子画像”上的素描。

怎么做？
数据对齐: 将您的每一笔买入交易记录，与您构建好的高频因子数据库进行匹配，匹配的键是股票代码和精确到分钟/秒的交易时间戳。配对好的数据集：@data\paired_trades_fifo.parquet

计算策略的因子暴露:

在一个分析窗口内（例如，每30分钟或每一天），计算策略所有买入股票的加权平均因子值，权重是每笔交易的交易金额 (tradeAmount)。

公式: 策略的Size暴露度 = Σ(交易金额_i * 市值因子_i) / Σ(交易金额_i)

与市场基准对比:

同时计算出在同一时间窗口内，全市场所有股票的加权平均因子值（权重通常是流通市值），作为“市场基准”。

可视化呈现: 绘制时间序列图，将“策略的因子暴露度”曲线和“市场的因子暴露度”曲线放在一起对比。

结果解读
如果策略的“市值因子暴露度”曲线长期且稳定地低于市场基准曲线，这便是一个强有力的证据，证明：您的策略存在显著的小市值偏好。

如果策略的“短周期动量因子暴露度”曲线在大部分时间为正，则说明这是一个追涨的趋势跟随策略；如果为负，则说明这是一个杀跌的高抛低吸策略。

## 第三步：因子收益归因分析
这是最顶层、最关键的分析，它能告诉您策略盈利的最终来源。

怎么做？
我们需要使用经典的多元线性回归模型。这个模型好比一个“过滤器”，能将策略的收益率“滤”成不同的组成部分。

准备回归数据:

因变量 (Y): 您的策略在每个分析周期（例如，每小时或每日）的收益率。

自变量 (X): 您需要构建“因子收益率”序列。最标准的方法是因子多空组合：在每个周期，做多因子值最高的20%的股票，同时做空因子值最低的20%的股票，这个组合的每日收益率就是该因子的收益率。

执行回归:

运行以下回归方程：
策略收益率=α+β 
size
​
 ×Size因子收益率+β 
vol
​
 ×Volatility因子收益率+...+ϵ

解读回归结果:

回归产出	它的名字	核心解读
β (系数)	因子载荷	衡量您的策略对某个因子的敏感度或依赖度。例如，β 
size
​
  = 0.8 意味着，当小市值因子本身上涨1%时，您的策略平均会上涨0.8%。这精确量化了您的策略风格。
α (截距项)	阿尔法收益	这是皇冠上的明珠。它代表在剔除了所有已知因子的影响后，策略还剩下的无法被解释的超额收益。一个长期、稳定且显著为正的 α，是证明策略具备独特选股能力的最终证据。
R 
2
  (R平方)	模型解释度	衡量您的因子模型能在多大程度上解释策略收益的波动。R 
2
 =70% 意味着策略70%的收益波动都可以归因于您选择的这些因子。一个较低的 R 
2
  反而可能说明策略的盈利逻辑非常独特。