# 收益分布与绝对盈亏页面优化指南

## 1. 页面目标
本页面（`daily_absolute_profit_light.html`）旨在通过日度资产净值（NAV）变动，直观展示策略的绝对盈利能力。核心目标是让用户一眼识别出策略的盈利稳定性、最大风险日以及整体累计回报。

## 2. 设计规范 (Design System)

### 2.1 配色方案 (A股标准)
*   **上涨/盈利 (Up/Profit)**: `#e53935` (Red-600)
*   **下跌/亏损 (Down/Loss)**: `#43a047` (Green-600)
*   **趋势线 (Trend)**: `#f59e0b` (Amber-500)
*   **中性/背景**: `bg-gray-50`, `text-gray-800`

### 2.2 布局结构 (Layout)
采用 **Dashboard 仪表盘** 布局，而非简单的“标题+图表”。
1.  **Header**: 标题、生成时间、数据来源说明。
2.  **KPI Cards (Top)**: 4个关键指标卡片，横向排列。
3.  **Main Chart (Middle)**: 全宽交互式图表，带时间筛选。
4.  **Details (Bottom)**: 双栏布局，左侧为一致性校验，右侧为分析说明。

### 2.3 技术栈
*   **CSS**: Tailwind CSS (CDN)
*   **Icons**: FontAwesome (CDN)
*   **Charts**: Plotly.js (Python生成)

## 3. 实施指南 (Implementation Guide)

请修改 `src/lightweight_analysis.py` 中的 `daily_absolute_profit_analysis` 函数。

### 3.1 KPI 计算逻辑
在绘图前，先计算以下核心指标：
```python
total_profit = profit_series.sum()
avg_profit = profit_series.mean()
max_profit = profit_series.max()
min_profit = profit_series.min()
win_rate = (profit_series > 0).mean()
```

### 3.2 Plotly 图表配置
**核心要求**：
*   **Bar Chart**: 颜色必须根据 `y >= 0` 动态映射为 `#e53935` 或 `#43a047`。
*   **Line Chart**: 添加 7日均线 (MA7)，颜色使用 `#f59e0b`，线宽 2.5。
*   **X轴交互**: 必须启用 `rangeslider` 和 `rangeselector` (1月, 3月, 6月, 全部)。
*   **背景**: 必须透明 (`rgba(0,0,0,0)`), 字体使用无衬线栈。

**代码片段参考**:
```python
fig_abs.update_layout(
    title=dict(text='日度绝对盈利趋势图', x=0, font=dict(size=18)),
    yaxis=dict(title='金额 (¥)', tickformat=',.0f', gridcolor='rgba(0,0,0,0.05)'),
    xaxis=dict(
        rangeselector=dict(
            buttons=list([
                dict(count=1, label="1月", step="month", stepmode="backward"),
                dict(count=3, label="3月", step="month", stepmode="backward"),
                dict(step="all", label="全部")
            ]),
            bgcolor='rgba(255,255,255,0.9)'
        ),
        rangeslider=dict(visible=True),
        type='date'
    ),
    height=500,
    hovermode='x unified',
    paper_bgcolor='rgba(0,0,0,0)',
    plot_bgcolor='rgba(0,0,0,0)'
)
```

### 3.3 HTML 模板重构
不再调用通用的 `_save_figure_with_details`，而是直接在函数内构建 HTML 字符串并写入文件。

**HTML 结构模板**:
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <!-- 引入 Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>body { font-family: "Inter", "Microsoft YaHei", sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- 1. 顶部标题 -->
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>日度绝对盈利（盯市）
            </h1>
            <!-- 生成时间 -->
        </div>

        <!-- 2. KPI 卡片组 (Grid Layout) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Profit Card -->
            <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-[#e53935]"> <!-- 动态边框色 -->
                <p class="text-xs font-semibold text-gray-500 uppercase">合计绝对盈利</p>
                <h3 class="text-2xl font-bold text-gray-800">¥...</h3>
            </div>
            <!-- 其他卡片: 日均盈利, 最大单日亏损, 胜率 -->
        </div>

        <!-- 3. 图表区域 -->
        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100">
            <div id="main_chart" class="w-full h-[500px]"></div>
        </div>

        <!-- 4. 底部详情 (校验 + 说明) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 现金校验卡片 -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-400">
                <!-- 内容 -->
            </div>
            <!-- 分析说明卡片 -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
                <!-- 内容 -->
            </div>
        </div>
    </div>
    
    <!-- 注入 Plotly 数据 -->
    <script>
        var figData = ...; // 替换为 fig.to_json()
        Plotly.newPlot('main_chart', figData.data, figData.layout, {responsive: true, displayModeBar: false});
    </script>
</body>
</html>
```

## 4. 具体操作步骤
1.  定位 `src/lightweight_analysis.py` 中的 `daily_absolute_profit_analysis` 函数。
2.  保留数据准备逻辑（直到计算出 `profit_series`）。
3.  **替换** 原有的 `fig_abs` 创建逻辑，应用上述 Plotly 配置。
4.  **替换** 原有的 `_save_figure_with_details` 调用。
5.  使用 f-string 构建完整的 HTML，填入计算出的 KPI 变量和 Plotly JSON 数据。
6.  直接使用 `output_path.write_text(html, encoding='utf-8')` 保存文件。