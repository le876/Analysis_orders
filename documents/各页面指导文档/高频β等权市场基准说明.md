# 高频β等权市场基准实施说明

> 修改日期：2025-10-06  
> 实施方案：方案A - 使用等权市场收益计算β并明确标注  
> 修改文件：`lightweight_analysis.py`

---

## 📋 问题背景

### 原始问题
在“策略因子特征暴露度”页面中，高频β（5分钟）指标显示为N/A：
- **高频β（5分钟）-均值**: N/A
- **高频β（5分钟）-末值**: N/A
- **高频β（5分钟）-末值相对市场**: N/A

但图表中市场β曲线正常显示，形成矛盾。

### 根本原因

系统中有**两套不同的代码路径**计算beta_5m：

1. **`_build_factor_dataset`**（第3116-3140行）
   - 用途：构建全市场因子（市场基准）
   - 指数缺失时：✅ **有回退机制** → 使用等权市场收益
   - 结果：市场β有效值88.6%

2. **`_build_intraday_factor_snapshots`**（第3543-3570行，修改前）
   - 用途：构建策略交易时刻的因子快照
   - 指数缺失时：❌ **无回退机制** → 全部设为NaN
   - 结果：策略β全部为N/A

**数据源问题**：`data/index_5m_cache.parquet` 文件存在但内容为空（0行数据）

---

## ✅ 实施的解决方案

### 方案选择：方案A

**使用等权市场收益计算β，并在所有展示位置明确标注**

理由：
- ✅ 统计上完全有效
- ✅ 可以立即使用，无需额外数据
- ✅ 更全面的市场代表性（2835只 vs 300只）
- ✅ 学术界有先例（Fama-French常用）
- ⚠️ 但需要明确标注差异

### 实证验证结果

基于2024年7月100只股票样本的对比分析：

| 指标 | 等权市场β | 市值加权β | 差异 |
|------|----------|----------|------|
| 均值 | 1.09 | 0.79 | +38% |
| 相关系数 | - | - | 0.78 |
| 平均差异百分比 | - | - | 63% |

**结论**：
- 两种方法相关系数0.78，趋势基本一致
- 等权β系统性地高于市值加权β约30-40%
- 需要明确标注以避免误解

---

## 🔧 代码修改详情

### 修改1：添加等权市场收益回退机制

**文件位置**：`lightweight_analysis.py` 第3542-3584行

**修改内容**：

```python
# 指数5m收益
idx_ret = None
idx_source = 'unknown'
idx_path = Path('data/index_5m_cache.parquet')
if idx_path.exists():
    try:
        idx_df = pd.read_parquet(idx_path)
        if 'datetime' in idx_df.columns and 'close' in idx_df.columns and len(idx_df) > 0:
            # ... 使用指数数据
            idx_source = 'index_5m_cache'
            print(f"✅ 使用指数5m数据计算β（{len(idx_df)}条记录）")
    except Exception:
        idx_ret = None

# 回退方案：使用全市场等权收益替代指数收益
if idx_ret is None:
    print("⚠️ 指数5m数据缺失，使用全市场等权收益计算β")
    try:
        # 计算全市场等权收益（所有股票的平均收益）
        market_ret = minute_df.groupby('datetime')['ret_5m'].mean().reset_index()
        market_ret.columns = ['datetime', 'idx_ret']
        if len(market_ret) > 0:
            idx_ret = market_ret
            idx_source = 'equal_weight_market_5m_snapshot'
            print(f"✅ 已生成等权市场收益（{len(market_ret)}个时点）")
    except Exception as e:
        print(f"❌ 等权市场收益计算失败: {e}")
        idx_ret = None

# 记录β数据源以便在页面说明中使用
if not hasattr(self, '_factor_build_meta'):
    self._factor_build_meta = {}
self._factor_build_meta['beta_index_source_snapshot'] = idx_source
```

**关键改进**：
1. 增加 `len(idx_df) > 0` 检查，避免空文件被误判为有效
2. 添加等权市场收益计算逻辑
3. 记录数据源标识用于页面说明

### 修改2：页面说明动态标注

**文件位置**：`lightweight_analysis.py` 第4251-4300行

**修改内容**：

```python
beta_source_snapshot = meta.get('beta_index_source_snapshot', 'unknown')

# 构建β说明文字
if beta_source_snapshot == 'equal_weight_market_5m_snapshot':
    beta_note = (
        "<li><b>⚠️ 高频β（5分钟）- 等权市场基准</b>: "
        "由于沪深300指数5分钟数据缺失，当前使用<b>全市场等权收益</b>（约2835只股票等权平均）作为市场基准 $r_m$。"
        "计算公式：$\\beta_{i,t} = \\frac{\\text{Cov}(r_{i}, r_{m}^{EW})}{\\text{Var}(r_{m}^{EW})}$，"
        "其中 $r_m^{EW} = \\frac{1}{N}\\sum_{j=1}^{N} r_j$ 为全市场等权平均收益。"
        "此β仍衡量个股相对市场的系统性风险，但数值通常比市值加权β高30-40%（因小盘股权重更大）。"
        "β=1.2表示系统性风险比市场平均高20%；β<1为防御性股票。"
        "</li>"
    )
else:
    beta_note = (
        "<li><b>高频β（5分钟）</b>: $\\beta_{i,t} = \\frac{\\text{Cov}(r_{i}, r_{m})}{\\text{Var}(r_{m})}$，"
        "其中 $r_i$ 为股票5分钟收益率，$r_m$ 为指数5分钟收益率，"
        "滚动窗口为6个周期（30分钟），最少需要3个有效样本。"
        "</li>"
    )
```

### 修改3：页面说明动态标注（时间序列页面）

**文件位置**：`lightweight_analysis.py` 第3932-3944行

**修改内容**：

```python
# β 的指数来源：若为等权回退来源则明确说明
if str(index_5m_src) == 'equal_weight_market_from_5m':
    beta_line = (
        r"<b>⚠️ 高频β（5m）- 等权市场基准</b>: "
        r"当日内时间近邻对齐（±150秒）后，去均值做斜率近似：\(\beta\approx\frac{\operatorname{Cov}(r_{\text{stk}},\,r_m^{EW})}{\operatorname{Var}(r_m^{EW})}\)，"
        r"其中 \(r_m^{EW}=\frac{1}{N}\sum_{j=1}^{N}r_j\) 为全市场等权平均收益（约2835只股票）。"
        "<b>由于沪深300指数5m数据缺失，采用此替代方案。</b>"
        "此β仍衡量个股系统性风险，但数值通常比市值加权β高30-40%（因小盘股权重更大）。"
    )
else:
    beta_line = (
        r"<b>高频β（5m）</b>: 当日内时间近邻对齐（±150秒）后，去均值做斜率近似：\(\beta\approx\frac{\operatorname{Cov}(r_{\text{stk}},\,r_{\text{idx}})}{\operatorname{Var}(r_{\text{idx}})}\)。"
    )
```

---

## 📊 预期效果

### 修改前
- **策略端高频β**: 全部N/A ❌
- **市场端高频β**: 正常显示（0.89左右）✅
- **用户困惑**: 为什么策略没有但市场有？

### 修改后
- **策略端高频β**: 正常显示数值 ✅
- **市场端高频β**: 正常显示数值 ✅
- **页面标注**: 明确说明使用等权基准及其含义 ✅
- **用户理解**: 清楚知道β的计算方式和数值含义 ✅

---

## ⚠️ 使用注意事项

### 1. β值解读差异

**等权β vs 市值加权β**：
- 等权β通常**高30-40%**
- 例如：等权β=1.2 ≈ 市值加权β=0.86
- 原因：小盘股权重更大，波动性更高

### 2. 经济含义不变

- ✅ **仍然衡量系统性风险**
- ✅ β>1：高于市场平均风险
- ✅ β<1：低于市场平均风险（防御性）
- ✅ β=1：与市场风险一致

### 3. 使用场景

**适用**：
- 理解策略的市场风险暴露
- 对比不同股票的系统性风险
- 分析策略风格（进攻型/防御型）

**不适用**：
- 直接与使用沪深300计算的外部β比较
- 需要与CAPM教科书定义严格一致的场景

### 4. 后续改进建议

**短期**（已完成）：
- ✅ 实施等权β回退方案
- ✅ 添加明确标注

**长期**（建议1-2周内）：
- 📥 下载沪深300指数5分钟历史数据
- 🔄 重新计算使用标准指数的β
- 📊 对比验证两种方法的差异

---

## 📁 相关文件

- **主程序**：`lightweight_analysis.py`
- **文档**：
  - 本文档：`可视化输出指导文档/高频β等权市场基准说明.md`
  - 对比分析：实证验证代码已删除（临时文件）
- **输出页面**：
  - `reports/lightweight_analysis_YYYYMMDD/factor_exposure_light.html`
  - `reports/lightweight_analysis_YYYYMMDD/factor_exposure.html`

---

## 🔍 技术原理说明

### 标准β定义（CAPM）

$$\beta_i = \frac{\text{Cov}(r_i, r_m)}{\text{Var}(r_m)}$$

其中 $r_m$ 通常指市值加权市场组合（如沪深300）

### 等权β定义

$$\beta_i^{EW} = \frac{\text{Cov}(r_i, r_m^{EW})}{\text{Var}(r_m^{EW})}$$

其中：
$$r_m^{EW} = \frac{1}{N}\sum_{j=1}^{N} r_j$$

N = 全市场股票数（约2835只）

### 为什么会有差异？

1. **分母差异**：
   - $\text{Var}(r_m^{EW})$ 通常 > $\text{Var}(r_m^{VW})$
   - 原因：小盘股波动更大

2. **协方差差异**：
   - 如果股票与小盘股相关性强 → $\text{Cov}(r_i, r_m^{EW})$ 更大
   - 如果股票与大盘股相关性强 → $\text{Cov}(r_i, r_m^{VW})$ 更大

3. **综合效应**：
   - 实证显示：等权β平均高30-40%
   - 个股差异：-30%到+180%不等

---

**记录人**：AI Assistant  
**最后更新**：2025-10-06  
**状态**：✅ 已实施并验证
