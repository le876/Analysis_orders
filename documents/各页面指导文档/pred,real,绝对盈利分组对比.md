### **第一步：数据预处理 -> 识别并匹配“交易对”**

这是最关键的一步。原始数据是逐笔订单（orders），我们需要将它们组合成一次完整的“买入-卖出”交易。您需要对数据进行分组，通常是按每个唯一的股票代码（`Code`）进行聚合。在每个股票分组内，将 `direction` 为 'B' 的买单和 `direction` 为 'S' 的卖单进行配对。

最常用的配对原则是**“先进先出”（FIFO, First-In, First-Out）**。这意味着，对于一只股票，最早的买入订单会优先与后续的卖出订单进行匹配。您需要编写一个算法来处理持仓量（position）的变化，以正确地将卖出交易分配给一个或多个买入交易。

**核心挑战**:
-   处理部分成交的情况（`tradeQty` < `orderQty`）。
-   管理跨越多笔交易的复杂匹配逻辑（例如，一笔大额卖单可能对应多笔小额买单）。

---

### **第二步：计算每笔完整交易的绝对收益**

对于每一个成功配对的“交易对”（即一次完整的买入和卖出操作），其绝对收益（盈亏）的计算公式如下。这个公式考虑了交易金额和相关的手续费。

$$
\text{Profit} = \text{tradeAmount}_{\text{sell}} - \text{tradeAmount}_{\text{buy}} - (\text{fee}_{\text{buy}} + \text{fee}_{\text{sell}})
$$

**公式解析**:
-   `tradeAmount_sell`: 卖出交易的总金额。
-   `tradeAmount_buy`: 配对的买入交易的总金额。
-   `fee_buy`: 买入时产生的手续费。
-   `fee_sell`: 卖出时产生的手续费。

您需要为每一个生成的“交易对”计算这个 `Profit` 值。

---

### **第三步：将收益归因到买入时的`pred`分组**

这是归因分析的核心。我们有了每一笔完整交易的 `Profit`。现在，需要将这个收益值与**触发这笔交易的原始信号**关联起来。

1.  **定位买入信号**: 对于每一笔交易对，找到其**最初买入订单**所对应的 `pred` 值。
2.  **分组**: 根据您预先设定的 `pred` 值分组规则（例如，按 `pred` 数值从低到高排序后等分为十组），判断该笔交易的买入 `pred` 值属于哪一个分组。
3.  **记录归因**: 创建一个新的数据结构（例如DataFrame），至少包含三列：`buy_pred`, `profit`, `group_id`。将每笔交易的这三个信息记录下来。

---

### **第四步：汇总与分析**

最后一步是聚合计算结果，以评估每个 `pred` 分组的整体盈利能力。

1.  **按组聚合**: 使用 `groupby()` 函数，按照 `group_id` 对上一步生成的数据进行分组。
2.  **计算总收益**: 对每个分组内的所有 `profit` 进行求和。这是衡量每个分组绝对盈利能力的核心指标。

$$
\text{Total Profit}_{\text{Group}_i} = \sum \text{Profit}_{\text{trade}_j} \quad (\text{其中 trade}_j \text{的买入pred属于 Group}_i)
$$

3.  **计算辅助指标（可选但推荐）**:
    -   **交易次数**: `count(profit)`
    -   **胜率**: `sum(profit > 0) / count(profit)`
    -   **平均盈亏**: `mean(profit)`
    -   **盈亏比**: `mean(profit[profit > 0]) / abs(mean(profit[profit < 0]))`

将这些结果整理成一个清晰的表格（按pred大小分为十组，每组pred使用柱状图，real使用折线图，绝对收益使用柱状图），您就可以直观地判断 `pred` 信号的有效性了。