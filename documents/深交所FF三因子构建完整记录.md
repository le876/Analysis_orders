# 深交所FF三因子构建与归因分析 - 完整记录

## 📊 项目概述

**目标：** 构建深交所Fama-French三因子模型，用于策略收益归因分析

**完成日期：** 2025-10-04

**数据期间：** 2024-01-02 ~ 2024-12-31 (242个交易日)

---

## ✅ 完成的工作

### 1. 数据获取（Tushare + AkShare + Baostock）

**数据源组合：**
- **Baostock**：历史PB数据、价格数据（主力，免费且稳定）
- **AkShare**：流通市值数据、市场指数数据
- **Tushare**：权限不足，仅用于测试

**获取结果：**
- ✅ 深交所股票宇宙：2,875只股票
- ✅ 全年PB数据：12个月 × ~2,800只/月
- ✅ 全年市值数据：12个月 × ~2,875只/月
- ✅ 全年价格数据：691,699条记录
- ✅ 市场指数：深证成指（399001）242天

### 2. FF因子构建（标准2×3双重排序）

**方法论：**
```
SMB = 1/3(S/H + S/M + S/L) - 1/3(B/H + B/M + B/L)
HML = 1/2(S/H + B/H) - 1/2(S/L + B/L)
MKT = R_index - R_f
```

**分组规则：**
- **Size（规模）：** 按流通市值中位数分为Small/Big
- **BM（账面市值比）：** 按30%/70%分位数分为Low/Middle/High
- **形成频率：** 月度重构
- **加权方式：** 组合内按流通市值加权

**最终覆盖率：**
- SMB_SZ: 242/251天 (96.4%)
- HML_SZ: 242/251天 (96.4%)
- MKT: 241/251天 (96.0%)

### 3. 策略收益数据修正

**问题发现：**
- 原NAV使用"相对净值"（从1.19开始），导致收益率被夸大10倍
- 原日均收益1.60%，年化4597%（不现实）

**修正方案：**
- 使用固定初始本金：¥62,090,669
- 日收益率 = 日PnL / 初始本金
- 修正后日均收益：0.333%，年化80.6%（合理）

### 4. FF3归因分析

**模型：**
```
R_strategy - R_f = α + β_MKT·MKT + β_SMB·SMB + β_HML·HML + ε
```

**全年结果（241天样本）：**
- **Alpha:** 0.317%/天，年化76.6% (p<0.001, 极显著)
- **β_MKT:** -0.01 (市场中性，不显著)
- **β_SMB:** -0.03 (轻微偏大盘，显著)
- **β_HML:** -0.14 (轻微偏成长，极显著)
- **R²:** 14.2%

**季度结果：**

| 季度 | Alpha | β_MKT | β_SMB | β_HML | R² | 样本数 |
|------|-------|-------|-------|-------|----|--------|
| Q1 | 0.318% | -0.07 | -0.05 | -0.06 | 43% | 57 |
| Q2 | 0.271% | -0.08 | -0.03 | +0.03 | 38% | 59 |
| Q3 | 0.201% | +0.02 | -0.04 | -0.07 | 17% | 64 |
| Q4 | 0.464% | +0.01 | -0.03 | -0.21 | 25% | 61 |

---

## 📁 生成的文件

### 数据文件

```
data/factors_ff_cn.parquet          # FF因子主文件
  - date, rf, r_mkt, mkt
  - smb_sz, hml_sz                   # 深交所因子

data/cache/                          # 中间缓存
  - all_sz_stocks.parquet            # 股票列表
  - fundamental_sz_pb_202401~12.parquet
  - fundamental_sz_circ_mv_202401~12.parquet
  - daily_price_sz_*.parquet

mtm_analysis_results/
  - mtm_returns.csv                  # 修正后策略收益
  - mtm_returns_old_nav_backup.csv   # 原文件备份
```

### 可视化文件

```
reports/lightweight_analysis_*/
  ├── factor_attribution_main.html       # 主页面（3图表）
  │   ├── 图1：滚动Alpha & Beta（双Y轴）
  │   ├── 图2：因子日度收益率
  │   └── 图3：滚动R²
  │
  ├── factor_attribution_quarterly.html  # 季度分析
  ├── ff3_static.csv                     # 全年回归结果
  └── ff3_quarterly.csv                  # 季度回归结果
```

### 脚本文件

```
scripts/
  ├── build_sz_ff_factors.py            # 主脚本（完整流程）
  ├── compute_sz_ff_from_cache.py       # 从缓存计算因子
  ├── fetch_sz_pb_baostock.py           # 获取PB数据
  ├── fetch_sz_mv_akshare.py            # 获取市值数据
  ├── fetch_sz_prices_full_year.py      # 获取价格数据
  ├── recalc_returns_fixed_capital.py   # 修正收益率
  └── show_ff3_results.py               # 显示结果
```

---

## 🎯 关键洞察

### 策略风格特征

1. **超强选股能力**
   - Alpha占策略收益95%
   - 年化Alpha ≈ 77%
   - 统计极显著（t=16.58, p<0.001）

2. **市场中性**
   - β_MKT ≈ 0
   - 不依赖大盘涨跌

3. **风格倾向**
   - 轻微偏好大盘股（β_SMB = -0.03）
   - 轻微偏好成长股（β_HML = -0.14）

4. **模型解释力**
   - R² = 14.2%（低）
   - 说明收益主要来自选股，非风格暴露
   - 可能存在其他未识别因子（行业、动量等）

### 负Beta获利原理

**关键公式：**
```
收益贡献 = β × 因子值
```

**典型案例（2024-10-08）：**
```
β_HML = -0.49 (策略偏成长)
HML = -5.45% (成长股大涨)
→ 贡献 = (-0.49) × (-0.0545) = +2.65% ✅
```

**解读：** 负×负=正，成长风格暴露在成长股强势时产生正收益

---

## ⚠️ 数据限制与注意事项

### 1. 前视偏差

**问题：**
- 市值数据使用AkShare当前值（2025年）
- 应用于2024年历史分析

**影响：**
- Size分组可能不准确
- 市值加权权重有偏差

**建议：**
- 结果用于风格分析和趋势识别 ✅
- 不应作为严格回测结论 ⚠️
- 有Tushare高级权限时应重新计算

### 2. PB数据质量

**来源：** Baostock历史pbMRQ
- ✅ 无前视偏差
- ✅ 覆盖率高（~97%）
- ⚠️ 部分停牌股票数据缺失

### 3. 价格数据

**来源：** Baostock前复权日线
- ✅ 质量稳定
- ⚠️ 11月数据异常（仅564只股票，后补全）

---

## 📋 使用指南

### 查看归因报告

1. **打开Dashboard：**
   ```
   reports/lightweight_analysis_*/lightweight_dashboard.html
   ```

2. **找到"因子归因（FF3）主页面"**

3. **图表解读：**
   - **图1（上左）：** Alpha和Beta滚动曲线
     - 左Y轴：Beta系数（-0.5到0.5范围）
     - 右Y轴：Alpha（橙色虚线，0到0.01范围）
   
   - **图2（上右）：** 因子日度收益率
     - 观察MKT/SMB/HML当天的市场环境
     - 配合图1的Beta，理解收益贡献方向
   
   - **图3（下方占满行）：** R²模型解释力
     - 高R²（>30%）→ 风格明确
     - 低R²（<15%）→ Alpha主导

### 理解负Beta盈利

**步骤：**
1. 查看图1某日的Beta值（如β_HML=-0.5）
2. 查看图2对应日期的因子值（如HML=-3%）
3. 计算贡献：(-0.5) × (-0.03) = +0.015 = +1.5% ✅

### 数据文件使用

**因子数据：**
```python
import pandas as pd
factors = pd.read_parquet('data/factors_ff_cn.parquet')
# 列：date, rf, r_mkt, mkt, smb_sz, hml_sz
```

**回归结果：**
```python
# 全年静态回归
static = pd.read_csv('reports/.../ff3_static.csv')

# 季度回归
quarterly = pd.read_csv('reports/.../ff3_quarterly.csv')

# 滚动回归
rolling = pd.read_csv('reports/.../ff3_rolling_30.csv')
```

---

## 🔧 技术细节

### 缓存机制

- **月度缓存：** PB和市值按月缓存，避免重复获取
- **断点续传：** 已获取的月份自动跳过
- **增量计算：** 价格数据支持增量缓存

### 性能优化

1. **日期类型统一：** 全部转为pd.Timestamp避免查找失败
2. **Set加速查找：** O(n) → O(1)
3. **提前过滤NaN：** 减少无效计算

### Bug修复历史

1. **日期索引错误：** DatetimeIndex[0]失败 → 改用.min()
2. **类型不一致：** merge时date类型冲突 → 统一为date类型
3. **日期查找失败：** numpy.datetime64作key失败 → 转为Timestamp
4. **NAV计算错误：** 相对净值 → 固定本金口径

---

## 📚 参考文献

**Fama-French三因子模型：**
- Fama, E. F., & French, K. R. (1993). Common risk factors in the returns on stocks and bonds. *Journal of Financial Economics*, 33(1), 3-56.

**中国市场应用：**
- 本分析使用深交所2×3双重排序方法
- 月度重构，市值加权
- 基于2,875只深交所股票

---

## 🎯 下一步建议

### 短期优化

1. **获取历史市值数据**
   - 升级Tushare权限
   - 或使用其他数据源（Wind、同花顺iFinD）

2. **扩展因子模型**
   - 添加动量因子（Carhart四因子）
   - 添加行业因子
   - 尝试Fama-French五因子

3. **改进分组方法**
   - 考虑流动性筛选
   - 剔除ST/退市股票
   - 上市满N天规则

### 长期方向

1. **多市场对比**
   - 构建沪市FF因子
   - 对比深市vs沪市vs全市场

2. **时变分析**
   - 分析Beta稳定性
   - 识别风格漂移

3. **实盘应用**
   - 实时因子更新
   - 风险预警系统

---

## 💡 常见问题

**Q1: 为什么R²这么低（14%）？**

A: 这说明策略收益主要来自选股能力（Alpha），而非市场、规模、价值风格暴露。这是好事，意味着策略独特性强。

**Q2: 负Beta为什么还能盈利？**

A: 关键看**贡献 = β × 因子值**
- β_HML = -0.5 (偏成长)
- HML = -3% (成长股涨)
- → 贡献 = +1.5% (负×负=正)

**Q3: Alpha = 0.317%/天 算高吗？**

A: 非常高！
- 年化约77%
- 对比策略总收益80.6%，Alpha占95%
- 说明几乎全靠选股能力

**Q4: 市值数据的前视偏差影响多大？**

A: 中等影响
- 对Beta符号判断基本准确
- 对Beta绝对值可能有10-20%偏差
- 建议：风格分析可信，精确回测需重做

---

## 📞 联系信息

**脚本位置：** `C:\Code\quant_trade\qlib\scripts\`

**可视化输出：** `C:\Code\quant_trade\qlib\reports\lightweight_analysis_20251004\`

**问题反馈：** 参考本文档或运行诊断脚本

---

**文档生成时间：** 2025-10-04  
**版本：** v1.0





