### 背景与目标

- **目标**: 系统评估并可视化策略在交易日内不同时间段（每30分钟一个时段）的真实盈利能力，帮助识别时间维度上的优势/劣势与改进方向。
- **数据**: 以`data/orders.parquet`为准（下称“订单数据”）。如需对比基准或市场状态，可额外读取已在项目中下载的指数数据（若无则跳过对应分析）。
- **落地**: 在不新增冗余脚本的原则下，优先在`optimized_analysis.py`中扩展实现，输出到`reports/`下当日子目录，命名如`slot_performance.html`等。

### 关键设计理念（为何不只看“简单均值”）

- **交易活跃度偏差**: 某些时段交易更密集，简单均值可能被零碎或异常交易放大/稀释；需要以名义成交额加权并做稳健处理（截尾/中位数）。
- **成本时变**: 费用/滑点在不同时间段差异显著，必须优先关注“净收益”（扣除成本）并单独展示成本贡献。
- **显著性与多重检验**: 48个半小时段同时检验会放大偶然性，需做显著性检验与FDR（Benjamini–Hochberg）校正。
- **条件依赖**: 时间优势可能仅在特定市场状态（上涨/下跌、波动率高/低）、特定星期几或多空方向上成立；建议做条件分组与分解。

### 字段与派生变量约定（尽量自适应订单数据差异）

- 必要字段（名称可通过配置映射）：
  - 交易时间: 如`datetime`/`order_time`/`filled_time`（要求精度至少到分钟）
  - 方向: `direction`或`side`（买=+1，卖=-1）
  - 成交数量与价格: `filled_qty`、`filled_price`（或`filled_value`）
  - 费用相关: `fee`、`slippage`（若无则置0）
  - 已实现盈亏或收益率（若有）: `pnl`或`return`
- 派生字段：
  - 名义金额`notional = abs(filled_qty * filled_price)`（若有`filled_value`则直接取其绝对值）
  - 净盈亏`net_pnl = (pnl if exists else 0) - fee - slippage`
  - 净收益率`net_ret = net_pnl / notional`（notional为0的记录剔除）
  - 符号收益率（方向一致性）`signed_ret = sign(direction) * net_ret`
  - 时段槽位`slot = floor_to_30min(local_exchange_time(datetime))`
  - 交易日`trade_date = date(local_exchange_time(datetime))`
- 时间与交易所：默认使用订单时间的本地交易所时区。若采集跨交易所数据，需统一到目标市场时区再分槽（避免夏令时错配）。

### 核心度量体系

1) 时段盈利
- **执行加权净收益率（主指标）**：
  - 每个交易日-时段，计算
    - `slot_notional_day = sum(notional)`
    - `slot_net_pnl_day = sum(net_pnl)`
    - `slot_exec_wret_day = sum(net_ret * notional) / sum(notional)`
  - 在所有交易日上做聚合得到：均值、截尾均值（如1%/99%或0.5%/99.5%）、中位数、标准差、样本数。
- **多空分解**：对`direction>0`与`direction<0`分别计算上述指标；并给出合成（净）效果。
- **成本刻画**：分时段给出`fee/notional`、`slippage/notional`的均值与分布（解释净值差异来源）。

2) 风险与显著性
- **t统计与置信区间**：对`slot_exec_wret_day`的日度截面进行t检验与95%置信区间；
  - 公式：\( t = \bar{r} / (s/\sqrt{n}) \)，CI用正态近似或自助法（bootstrap）。
- **非参数稳健性**：Wilcoxon符号秩检验（可选）。
- **多重检验**：对全部时段的p值做Benjamini–Hochberg FDR控制（如q=0.10），标注显著槽位。

3) 条件与结构
- **市场状态条件**（可选，若有基准）：将交易日按“基准当日涨/跌”“高/低波动日”分组后，重复1)~2)。
- **星期几 × 时段**：二维热力图观察周内节律。
- **成交活跃度/换手**：展示`slot_notional_day`的分布及其与收益的关系（避免“赚得多但几乎不发生”的错觉）。

### 可视化输出清单（建议均为交互式HTML）

- **时段平均净收益率（主图）**：
  - X轴：半小时槽位（从最早到最晚）；Y轴：`mean(slot_exec_wret_day)`。
  - 误差线：95%CI；柱子颜色表示FDR显著性；副轴折线叠加该槽位的平均`slot_notional_day`（规模）。
- **时段t统计（或效应量）条形图**：一眼看显著性强弱与方向。
- **多空分解对比**：两个并排条形图（多、空），同样带CI与显著性标注。
- **成本/滑点分解**：堆叠条形图显示不同槽位的`fee/notional`、`slippage/notional`均值。
- **星期几 × 时段热力图**：单元格为均值或t统计，展示节律性结构。
- **市场状态分面图**（可选）：上涨日/下跌日两列对比同一指标。
- （可选）**稳健性对比**：均值 vs 截尾均值 vs 中位数的折线或分面，检视是否由极端点驱动。

### 统计与清洗细节

- **去极值/稳健**：对日内槽位收益的横截面按分位数做Winsorize（如0.5%与99.5%），并同时给出原始均值与截尾均值以供对比。
- **最小样本要求**：槽位在样本日覆盖数低于阈值（如≥20个交易日）可标注为灰、或从统计检验中剔除。
- **名义金额阈值**：交易名义额过小的记录可能是噪声，设置`min_notional`过滤（如日内槽位累积名义额低于阈值的日-槽位不计入统计）。
- **方向一致性**：多、空分开统计，避免相互抵消掩盖结构；同时提供合并视图用于实际执行参考。
- **时间槽划分**：以半小时为单位，边界取整（00、30），跨市场默认按数据本地时区；若为A股，注意午间休市自然出现空槽位。

### 实现约定（供在`optimized_analysis.py`中落地）

- **函数建议**：
  - `compute_slot_metrics(orders_df, bin_minutes=30, fdr_q=0.10, winsor=(0.005, 0.995), min_days=20, min_slot_notional=None, groupby_cols=None) -> (slot_daily_metrics, slot_summary)`
  - `plot_slot_performance(slot_summary, slot_daily_metrics, output_dir)`
  - `plot_slot_decomposition_costs(slot_summary, output_dir)`
  - `plot_slot_heatmap(slot_daily_metrics, by="weekday"|"market_state", output_dir)`
- **聚合规范**：
  - 日-槽位层面：返回`slot_exec_wret_day`、`slot_notional_day`、`net_cost_rate_day=(fee+slippage)/notional`、`direction`等。
  - 槽位汇总层面：`mean/median/trimmed_mean/std/n`、`t_stat/p_value`、`ci_low/ci_high`、`fdr_sig`。
- **显著性与FDR**：对每个图表的槽位均以`p_value`经BH-FDR（q=0.10）标注显著性（如颜色或星号）。
- **输出路径**：与现有报告目录保持一致，如`reports/lightweight_analysis_YYYYMMDD/slot_performance.html`、`slot_heatmap.html`、`slot_costs.html`等。
- **可配置性**：以`argparse`或集中`CONFIG`方式暴露参数（时段粒度、winsor阈值、FDR阈值、最小样本数、是否分解多空/市场状态等）。

### 最小可用基线（如果缺失`pnl/return`列）

- 若缺少已实现盈亏/收益率：
  - 方案A（推荐，需行情）：用`filled_price`与下一根bar的收盘/中间价估算一次性持有到下一bar的收益率（执行偏差检验）。
  - 方案B（保守）：仅统计成本率（`(fee+slippage)/notional`）与成交活跃度，暂不画收益显著性相关图；待补齐行情或PnL再回填主图。

### 风险与边界

- **样本泄漏**：确保收益率定义对应“交易后”的价格变动，不能使用生成信号时段的未来信息。
- **时区/夏令时**：跨市场数据需统一到交易所时区再分槽。
- **覆盖偏差**：极端市况或节假日导致的非典型交易日可能扭曲结果，建议同步给出样本日数与覆盖率。
- **交易活跃度驱动**：以名义额加权虽更贴近真实执行，但也可能把“在该时段交易较多”与“该时段更有优势”混为一谈；因此同时给出非加权/中位数稳健版本作对照。

### 实施步骤（供他人据此编码）

1. 读取`data/orders.parquet`，完成字段映射与时间本地化；构造`notional`、`net_pnl`、`net_ret`、`signed_ret`、`slot`、`trade_date`。
2. 以`trade_date, slot`分组，生成日-槽位层面的`slot_exec_wret_day`、`slot_notional_day`、`net_cost_rate_day`、多空子样本。
3. 清洗：应用`winsor`、`min_days`、`min_slot_notional`等规则；生成干净的`slot_daily_metrics`。
4. 计算每个槽位的均值/中位数/截尾均值、t统计、CI与p值；对所有槽位的p值做BH-FDR校正，标记显著性。
5. 产出可视化：主图（平均净收益+CI+显著性+成交额）、t统计图、多空分解图、成本分解图、`weekday × slot`热力图、（可选）市场状态分面图。
6. 保存到`reports/...`目录，并在控制台打印样本覆盖与参数摘要，确保可复现。

### 附：统计定义与公式

- t统计：\( t = \bar{r} / (s/\sqrt{n}) \)；95%CI：\( \bar{r} \pm 1.96\, s/\sqrt{n} \)。
- BH-FDR：对p值升序排列，找到最大k使得\( p_{(k)} \le k\,q/m \)，其中m为检验数；标注序号≤k的槽位为显著。
- 截尾均值：对样本按分位数裁剪两端（如0.5%与99.5%）后计算均值。

### 预期洞见与后续优化方向

- 哪些半小时段在净收益和风险调整收益上显著为正/为负；负的时段可考虑降低参与度或调整滑点模型。
- 多空是否对称、成本是否主导时段差异；若成本主导，可优化交易分布（前移/后移）或改进执行。
- 若优势仅在特定市场状态或特定星期几出现，考虑做时变权重或条件化执行策略。


