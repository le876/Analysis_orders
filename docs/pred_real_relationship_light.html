
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1" />
                <title>预测值与实际收益关系分析</title>
                <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { margin: 0 0 15px 0; font-size: 22px; }
                    .card { background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
                    .chart-container { margin-bottom: 20px; }
                    .metrics-section { margin-top: 15px; }
                    .explain { margin-top: 14px; color: #444; line-height: 1.7; }
                    table td, table th { border-bottom: 1px solid #eee; padding: 8px; }
                </style>
                <script>
                    window.MathJax = {
                        tex: {
                            inlineMath: [["$","$"],["\(","\)"]],
                            displayMath: [["$$","$$"],["\[","\]"]],
                            processEscapes: true
                        },
                        options: { skipHtmlTags: ["script","noscript","style","textarea","pre","code"] },
                        svg: { fontCache: 'global' }
                    };
                </script>
                <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" onerror="this.onerror=null; this.src='assets/mathjax/tex-chtml-full.js';"></script>
            </head>
            <body>
                <div class="card" id="page-root"> 
                    <h1>预测值与实际收益关系分析</h1>
                    <div class="chart-container">
                        
                <div id="pred_real_relationship_light" class="plotly-graph-div" style="height:800px; width:100%;"></div>
                <script type="text/javascript">
                    window.PLOTLYENV=window.PLOTLYENV || {};
                    (function() {
                        var fig = {"data": [{"hovertemplate": "分组: %{x}<br>平均pred: %{y:.4f}<extra></extra>", "marker": {"color": "rgba(231, 76, 60, 0.7)"}, "name": "平均预测值 (pred)", "x": ["G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10"], "y": [0.5671, 1.6664, 1.8573, 2.0267, 2.1931, 2.3754, 2.6015, 2.9576, 3.5646, 5.4706], "type": "bar", "xaxis": "x", "yaxis": "y", "text": ["0.57", "1.67", "1.86", "2.03", "2.19", "2.38", "2.60", "2.96", "3.56", "5.47"], "textposition": "outside"}, {"hovertemplate": "分组: %{x}<br>平均real: %{y:.4f}<extra></extra>", "line": {"color": "steelblue", "width": 3}, "marker": {"color": "steelblue", "size": 7}, "mode": "lines+markers", "name": "平均真实标签 (real)", "x": ["G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10"], "y": [-4.1191, 0.8659, 0.9976, 1.1409, 1.3074, 1.4611, 1.6544, 2.0087, 2.631, 4.5481], "type": "scatter", "xaxis": "x", "yaxis": "y"}, {"hovertemplate": "分组: %{x}<br>总绝对收益: %{y:.2f}<extra></extra>", "marker": {"color": "steelblue"}, "name": "总绝对收益", "opacity": 0.8, "text": ["1782534", "424020", "444664", "544186", "738328", "958945", "1255628", "1884079", "3866504", "9444315"], "textposition": "outside", "x": ["G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10"], "y": [1782534.0402, 424019.5961, 444664.2306, 544185.7822, 738328.1287, 958944.894, 1255628.0178, 1884079.2567, 3866503.5808, 9444314.8936], "type": "bar", "xaxis": "x2", "yaxis": "y2"}, {"hovertemplate": "分组: %{x}<br>胜率: %{y:.1f}%<extra></extra>", "line": {"color": "green", "dash": "dash", "width": 2}, "marker": {"color": "green", "size": 6}, "mode": "lines+markers", "name": "胜率 (%)", "x": ["G1", "G2", "G3", "G4", "G5", "G6", "G7", "G8", "G9", "G10"], "y": [54.32699939676795, 50.6738790510132, 50.84373784596824, 50.81020585538927, 51.226094238011896, 51.33448956022367, 51.23187312976736, 52.185732711578524, 56.895552715756395, 62.86586261226401], "type": "scatter", "xaxis": "x2", "yaxis": "y3"}], "layout": {"template": {"data": {"histogram2dcontour": [{"type": "histogram2dcontour", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "choropleth": [{"type": "choropleth", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "histogram2d": [{"type": "histogram2d", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "heatmap": [{"type": "heatmap", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "contourcarpet": [{"type": "contourcarpet", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "contour": [{"type": "contour", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "surface": [{"type": "surface", "colorbar": {"outlinewidth": 0, "ticks": ""}, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]]}], "mesh3d": [{"type": "mesh3d", "colorbar": {"outlinewidth": 0, "ticks": ""}}], "scatter": [{"fillpattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}, "type": "scatter"}], "parcoords": [{"type": "parcoords", "line": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterpolargl": [{"type": "scatterpolargl", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "bar": [{"error_x": {"color": "#2a3f5f"}, "error_y": {"color": "#2a3f5f"}, "marker": {"line": {"color": "#E5ECF6", "width": 0.5}, "pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "bar"}], "scattergeo": [{"type": "scattergeo", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterpolar": [{"type": "scatterpolar", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "histogram": [{"marker": {"pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "histogram"}], "scattergl": [{"type": "scattergl", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatter3d": [{"type": "scatter3d", "line": {"colorbar": {"outlinewidth": 0, "ticks": ""}}, "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scattermap": [{"type": "scattermap", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scattermapbox": [{"type": "scattermapbox", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scatterternary": [{"type": "scatterternary", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "scattercarpet": [{"type": "scattercarpet", "marker": {"colorbar": {"outlinewidth": 0, "ticks": ""}}}], "carpet": [{"aaxis": {"endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f"}, "baxis": {"endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f"}, "type": "carpet"}], "table": [{"cells": {"fill": {"color": "#EBF0F8"}, "line": {"color": "white"}}, "header": {"fill": {"color": "#C8D4E3"}, "line": {"color": "white"}}, "type": "table"}], "barpolar": [{"marker": {"line": {"color": "#E5ECF6", "width": 0.5}, "pattern": {"fillmode": "overlay", "size": 10, "solidity": 0.2}}, "type": "barpolar"}], "pie": [{"automargin": true, "type": "pie"}]}, "layout": {"autotypenumbers": "strict", "colorway": ["#636efa", "#EF553B", "#00cc96", "#ab63fa", "#FFA15A", "#19d3f3", "#FF6692", "#B6E880", "#FF97FF", "#FECB52"], "font": {"color": "#2a3f5f"}, "hovermode": "closest", "hoverlabel": {"align": "left"}, "paper_bgcolor": "white", "plot_bgcolor": "#E5ECF6", "polar": {"bgcolor": "#E5ECF6", "angularaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "radialaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}}, "ternary": {"bgcolor": "#E5ECF6", "aaxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "baxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}, "caxis": {"gridcolor": "white", "linecolor": "white", "ticks": ""}}, "coloraxis": {"colorbar": {"outlinewidth": 0, "ticks": ""}}, "colorscale": {"sequential": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "sequentialminus": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "diverging": [[0, "#8e0152"], [0.1, "#c51b7d"], [0.2, "#de77ae"], [0.3, "#f1b6da"], [0.4, "#fde0ef"], [0.5, "#f7f7f7"], [0.6, "#e6f5d0"], [0.7, "#b8e186"], [0.8, "#7fbc41"], [0.9, "#4d9221"], [1, "#276419"]]}, "xaxis": {"gridcolor": "white", "linecolor": "white", "ticks": "", "title": {"standoff": 15}, "zerolinecolor": "white", "automargin": true, "zerolinewidth": 2}, "yaxis": {"gridcolor": "white", "linecolor": "white", "ticks": "", "title": {"standoff": 15}, "zerolinecolor": "white", "automargin": true, "zerolinewidth": 2}, "scene": {"xaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}, "yaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}, "zaxis": {"backgroundcolor": "#E5ECF6", "gridcolor": "white", "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white", "gridwidth": 2}}, "shapedefaults": {"line": {"color": "#2a3f5f"}}, "annotationdefaults": {"arrowcolor": "#2a3f5f", "arrowhead": 0, "arrowwidth": 1}, "geo": {"bgcolor": "white", "landcolor": "#E5ECF6", "subunitcolor": "white", "showland": true, "showlakes": true, "lakecolor": "white"}, "title": {"x": 0.05}, "mapbox": {"style": "light"}}}, "xaxis": {"anchor": "y", "domain": [0.0, 0.94], "title": {"text": "预测值分组 (从低到高)"}}, "yaxis": {"anchor": "x", "domain": [0.56, 1.0], "title": {"text": "平均预测值"}}, "xaxis2": {"anchor": "y2", "domain": [0.0, 0.94], "title": {"text": "预测值分组 (从低到高)"}}, "yaxis2": {"anchor": "x2", "domain": [0.0, 0.44], "title": {"text": "总绝对收益"}}, "yaxis3": {"anchor": "x2", "overlaying": "y2", "side": "right", "title": {"text": "胜率 (%)"}, "range": [45, 55]}, "annotations": [{"font": {"size": 16}, "showarrow": false, "text": "pred-true对比（按买入pred分组）", "x": 0.47, "xanchor": "center", "xref": "paper", "y": 1.0, "yanchor": "bottom", "yref": "paper"}, {"font": {"size": 16}, "showarrow": false, "text": "绝对收益与胜率（按买入pred分组）", "x": 0.47, "xanchor": "center", "xref": "paper", "y": 0.44, "yanchor": "bottom", "yref": "paper"}], "shapes": [{"line": {"color": "gray", "dash": "dash"}, "opacity": 0.5, "type": "line", "x0": 0, "x1": 1, "xref": "x2 domain", "y0": 0, "y1": 0, "yref": "y2"}], "legend": {"x": 0.02, "y": 0.98}, "title": {"text": "预测性能与盈利能力分组分析（基于完整交易）<br><sub>pred-real相关性: 0.8807 | pred-绝对收益相关性: 0.8564 | 分组数: 10 | 交易对数: 4,956,827</sub>"}, "height": 800, "hovermode": "x unified", "bargap": 0.3}};
                        var cfg = {"displayModeBar": false, "displaylogo": false, "modeBarButtonsToRemove": ["pan2d", "lasso2d"]};
                        if (document.getElementById("pred_real_relationship_light")) {
                            Plotly.newPlot("pred_real_relationship_light", fig.data || [], fig.layout || {}, cfg);
                        }
                    })();
                </script>
                
                    </div>
                    <div class="metrics-section">
                        
                <table style="width:100%;border-collapse:collapse;margin:10px 0;">
                    <thead>
                        <tr style="background:#f4f6f8;text-align:left;"><th style="padding:8px">指标</th><th style="padding:8px">数值</th></tr>
                    </thead>
                    <tbody><tr><td>分组数量</td><td>10</td></tr><tr><td>完整交易对数</td><td>4,956,827</td></tr><tr><td>总绝对盈利</td><td>46243413.65</td></tr><tr><td>平均每笔盈利</td><td>9.33</td></tr><tr><td>整体胜率</td><td>53.8%</td></tr><tr><td>pred-real相关性</td><td>0.8807</td></tr><tr><td>pred-绝对收益相关性</td><td>0.8564</td></tr><tr><td>预测值范围</td><td>-9.9618 ~ 15.6608</td></tr><tr><td>最高组总收益</td><td>9444314.89</td></tr><tr><td>最低组总收益</td><td>424019.60</td></tr><tr><td>收益区分度</td><td>9020295.30</td></tr></tbody>
                </table>
                
                    </div>
                    <div class="explain">
        <h4>🎯 基于完整交易的绝对收益分析说明</h4>
        <ul>
            <li><b>分析目的</b>: 验证买入时的预测值与完整交易绝对收益的关系</li>
            <li><b>配对方法</b>: 采用FIFO（先进先出）原则配对买卖订单</li>
            <li><b>收益计算</b>: 绝对收益 = 卖出金额 - 买入金额 - 买入手续费 - 卖出手续费</li>
            <li><b>分组依据</b>: 按买入时的pred值将完整交易分为10组</li>
            <li><b>相关性</b>: pred-real=0.8807，pred-绝对收益=0.8564</li>
        </ul>
        
        <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #17a2b8;">
        <h4>📋 完整交易配对详细过程</h4>
        <ol>
            <li><b>数据预处理</b>: 提取买卖订单的关键字段（<code>Code</code>、<code>direction</code>、<code>pred</code>、<code>tradeAmount</code>、<code>fee</code>、<code>tradeQty</code>）</li>
            <li><b>按股票分组</b>: 分别处理每只 <code>Code</code> 的订单序列</li>
            <li><b>FIFO配对算法</b>:
                <ul>
                    <li>维护买入订单队列，按 <code>Timestamp</code> 先后排序</li>
                    <li>每个方向为 <code>S</code>（卖出）的订单按FIFO原则与买入订单匹配</li>
                    <li>处理部分成交情况（一个卖单对应多个买单或反之）</li>
                </ul>
            </li>
            <li><b>绝对收益计算</b>: 
                单笔配对绝对收益 = 卖出时 <code>tradeAmount</code> - 买入时 <code>tradeAmount</code> - 买入时 <code>fee</code> - 卖出时 <code>fee</code>
            </li>
            <li><b>归因分析</b>: 将每笔完整交易的收益归因到买入时的 <code>pred</code> 值</li>
            <li><b>分组统计</b>: 按买入时 <code>pred</code> 值分10组，计算各组总收益、平均收益、胜率</li>
        </ol>
        </div>
        
        <h4>📌 未实现盈亏如何计算（Recon）</h4>
        <p><b>定义</b>：对每只 <code>Code</code>，先用 FIFO 将买卖配对得到已实现盈亏；剩余未被配对的头寸为未平仓部分，其估值采用期末价格近似（本实现使用该股票<strong>最后一笔订单的 <code>price</code> 字段</strong>作为期末价近似）。</p>
        <ol>
            <li><b>剩余头寸</b>：
                <br>剩余多头数量 = 方向为 <code>B</code> 的总 <code>tradeQty</code> − 已配对成交量
                <br>剩余空头数量 = 方向为 <code>S</code> 的总 <code>tradeQty</code> − 已配对成交量
            </li>
            <li><b>期末价</b>：该股票最后一笔订单的 <code>price</code>（收盘价近似）。</li>
            <li><b>未实现盈亏</b>：
                <br>多头：剩余多头数量 × 期末价 − 剩余多头成本 − 剩余多头费用
                <br>空头：剩余空头所得 − 剩余空头数量 × 期末价 − 剩余空头费用
                <br>合计为两者求和。
            </li>
        </ol>
        <p><b>本期Recon</b>：已实现盈亏=46,243,413.65，未实现盈亏=3,154,288.79，合计=49,397,702.44；盯市总绝对盈利=50,017,672.01；差额=-619,969.57。</p>
        <ul>
            <li>差额来源：末价近似与收盘价差、<code>fee</code> 四舍五入误差、股息/融资等现金流。</li>
            <li>结论：两口径已高度一致。<b>信号归因</b>建议采用配对口径（已实现+组归因），<b>整段总盈利</b>建议采用盯市口径。</li>
        </ul>
        </div>
                </div>
                <script>
                    (function ensureMathJax() {
                        var rootEl = document.getElementById('page-root') || document.body;
                        function typeset() {
                            if (window.MathJax) {
                                if (window.MathJax.typesetPromise) {
                                    window.MathJax.typesetPromise([rootEl]).catch(function (err) {
                                        if (window.console && window.console.warn) {
                                            console.warn('MathJax typeset failed:', err);
                                        }
                                    });
                                } else if (window.MathJax.Hub && window.MathJax.Hub.Queue) {
                                    window.MathJax.Hub.Queue(['Typeset', window.MathJax.Hub, rootEl]);
                                }
                            }
                        }
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', typeset);
                        } else {
                            typeset();
                        }
                        window.addEventListener('load', typeset);
                        var mjScript = document.getElementById('MathJax-script');
                        if (mjScript && !mjScript.hasAttribute('data-mathjax-listener')) {
                            mjScript.addEventListener('load', typeset);
                            mjScript.setAttribute('data-mathjax-listener', 'true');
                        }
                        if (!window.MathJax) {
                            var attempts = 0;
                            var timer = setInterval(function () {
                                attempts += 1;
                                if (window.MathJax) {
                                    clearInterval(timer);
                                    typeset();
                                } else if (attempts > 20) {
                                    clearInterval(timer);
                                }
                            }, 250);
                        }
                    })();
                </script>
            </body>
            </html>
            